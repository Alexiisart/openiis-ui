<div class="table-container" [class]="getContainerClasses()">
  <!-- Table Header/Toolbar -->
  @if (showHeader) {
  <div class="table-header">
    <div class="table-title-section">
      @if (title) {
      <h3 class="table-title">{{ title }}</h3>
      } @if (subtitle) {
      <p class="table-subtitle">{{ subtitle }}</p>
      }
    </div>

    <div class="table-actions">
      <!-- Search -->
      @if (searchable) {
      <openiis-input
        type="search"
        placeholder="Buscar..."
        variant="outlined"
        size="sm"
        iconLeft="search"
        [(value)]="searchTerm"
        (valueChange)="onSearch($event)"
        class="table-search"
      />
      }

      <!-- Custom Actions -->
      <div class="table-custom-actions">
        <ng-content select="[slot=actions]"></ng-content>
      </div>
    </div>
  </div>
  }

  <!-- Filters -->
  @if (showFilters && visibleFilters.length > 0) {
  <div class="table-filters">
    @for (filter of visibleFilters; track filter.column) {
    <div class="filter-item">
      <label class="filter-label">{{ getColumnLabel(filter.column) }}</label>

      @if (getColumnFilterType(filter.column) === 'text') {
      <openiis-input
        type="text"
        size="sm"
        variant="outlined"
        [value]="filter.value"
        (valueChange)="onFilterChange(filter.column, $event)"
        placeholder="Filtrar..."
      />
      } @if (getColumnFilterType(filter.column) === 'select') {
      <select
        class="filter-select"
        [value]="filter.value"
        (change)="onFilterSelectChange($event, filter.column)"
      >
        <option value="">Todos</option>
        @for (option of getColumnFilterOptions(filter.column); track
        option.value) {
        <option [value]="option.value">
          {{ option.label }}
        </option>
        }
      </select>
      } @if (filter.value) {
      <openiis-button
        type="ghost"
        size="sm"
        iconLeft="times"
        (clickEvent)="clearFilter(filter.column)"
      />
      }
    </div>
    }
  </div>
  }

  <!-- Selection Info -->
  @if (selectable && selection.selectedRows.length > 0) {
  <div class="table-selection-info">
    <span class="selection-count">
      {{ selection.selectedRows.length }} elemento(s) seleccionado(s)
    </span>
    <openiis-button
      type="ghost"
      size="sm"
      text="Limpiar selección"
      (clickEvent)="clearSelection()"
    />
  </div>
  }

  <!-- Table Wrapper -->
  <div class="table-wrapper" #tableWrapper>
    <table class="table" [class]="getTableClasses()">
      <!-- Table Head -->
      <thead class="table-head">
        <tr class="table-row">
          <!-- Selection Column -->
          @if (selectable) {
          <th class="table-cell table-cell-checkbox">
            <openiis-checkbox
              [checked]="selection.selectAll"
              [indeterminate]="selection.indeterminate"
              (checkedChange)="toggleSelectAll($event)"
              ariaLabel="Seleccionar todos"
            />
          </th>
          }

          <!-- Data Columns -->
          @for (column of columns; track column.key) {
          <th
            class="table-cell table-cell-header"
            [class]="getHeaderCellClasses(column)"
            [style.width]="column.width"
            [style.min-width]="column.minWidth"
            [style.max-width]="column.maxWidth"
            [style.text-align]="column.align"
            [attr.aria-sort]="getAriaSortValue(column)"
            [class.sortable]="column.sortable"
            [class.sticky]="column.sticky"
            (click)="onSort(column)"
          >
            <div class="table-cell-content">
              <span class="column-label">{{ column.label }}</span>

              @if (column.sortable) {
              <span
                class="sort-indicator"
                [class.sort-asc]="getSortDirection(column.key) === 'asc'"
                [class.sort-desc]="getSortDirection(column.key) === 'desc'"
              >
                @if (getSortDirection(column.key) === 'none') {
                <span class="material-icons">unfold_more</span>
                } @if (getSortDirection(column.key) === 'asc') {
                <span class="material-icons">expand_less</span>
                } @if (getSortDirection(column.key) === 'desc') {
                <span class="material-icons">expand_more</span>
                }
              </span>
              }
            </div>
          </th>
          }
        </tr>
      </thead>

      <!-- Table Body -->
      @if (!loading && processedData.length > 0) {
      <tbody class="table-body">
        @for (row of paginatedData; track trackByFn($index, row); let i =
        $index) {
        <tr
          class="table-row"
          [class]="getRowClasses(row, i)"
          [attr.aria-selected]="isRowSelected(row)"
          (click)="onRowClick(row, i, $event)"
          (keydown)="onRowKeyDown(row, i, $event)"
        >
          <!-- Selection Column -->
          @if (selectable) {
          <td class="table-cell table-cell-checkbox">
            <openiis-checkbox
              [checked]="isRowSelected(row)"
              (checkedChange)="toggleRowSelection(row, $event)"
              [ariaLabel]="'Seleccionar fila ' + (i + 1)"
            />
          </td>
          }

          <!-- Data Columns -->
          @for (column of columns; track column.key) {
          <td
            class="table-cell"
            [class]="getCellClasses(column, row)"
            [style.text-align]="column.align"
            [class.sticky]="column.sticky"
            [attr.data-label]="column.label"
          >
            <div
              class="table-cell-content"
              [innerHTML]="getCellContent(column, row, i)"
            ></div>
          </td>
          }
        </tr>
        }
      </tbody>
      }
    </table>

    <!-- Loading State -->
    @if (loading) {
    <div class="table-loading">
      <openiis-spinner size="lg" variant="circle" />
      <span class="loading-text">Cargando datos...</span>
    </div>
    }

    <!-- Empty State -->
    @if (!loading && processedData.length === 0) {
    <openiis-empty-state
      [icon]="emptyIcon"
      [title]="emptyTitle"
      [message]="emptyMessage"
      [buttonText]="emptyButtonText"
      (buttonClick)="onEmptyAction()"
    />
    }
  </div>

  <!-- Pagination -->
  @if (paginated && processedData.length > 0) {
  <div class="table-pagination">
    <div class="pagination-info">
      <span class="pagination-text">
        Mostrando {{ getPaginationStart() }} - {{ getPaginationEnd() }} de
        {{ pagination.totalItems }} elementos
      </span>

      @if (pagination.showSizeOptions) {
      <select
        class="page-size-select"
        [value]="pagination.pageSize"
        (change)="onSelectChange($event)"
      >
        @for (size of pagination.sizeOptions; track size) {
        <option [value]="size">{{ size }} por página</option>
        }
      </select>
      }
    </div>

    <div class="pagination-controls">
      <openiis-button
        type="ghost"
        size="sm"
        iconLeft="angle-left"
        [disabled]="pagination.page === 1"
        (clickEvent)="goToPage(pagination.page - 1)"
        ariaLabel="Página anterior"
      />

      <span class="pagination-pages">
        @for (page of getVisiblePages(); track page) {
        <openiis-button
          [type]="page === pagination.page ? 'primary' : 'ghost'"
          size="sm"
          [text]="page.toString()"
          (clickEvent)="goToPage(page)"
          [ariaLabel]="'Ir a página ' + page"
        />
        }
      </span>

      <openiis-button
        type="ghost"
        size="sm"
        iconLeft="angle-right"
        [disabled]="pagination.page === pagination.totalPages"
        (clickEvent)="goToPage(pagination.page + 1)"
        ariaLabel="Página siguiente"
      />
    </div>
  </div>
  }
</div>
